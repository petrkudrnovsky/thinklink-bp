# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    # Note: when changing the allowed mime types, also check tha allowed mime types in the App\Form\DTO\UploadFileFormData class (in the Assert section)
    # Source: https://www.iana.org/assignments/media-types/media-types.xhtml
    app.allowed_image_mime_types: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml']
    app.allowed_pdf_mime_types: ['application/pdf']
    app.allowed_note_mime_types: ['text/plain', 'text/markdown']
    app.allowed_zip_mime_types: ['application/zip']
    app.allowed_mime_types: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml', 'application/pdf', 'text/plain', 'text/markdown', 'application/zip']
    app.image_upload_directory: '%kernel.project_dir%/public/uploads/images'
    app.pdf_upload_directory: '%kernel.project_dir%/public/uploads/pdf'
    app.temp_upload_directory: '%kernel.project_dir%/var/temp'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    App\Form\Validator\UploadedFileConstraintValidator:
        arguments:
            $allowedMimeTypes: '%app.allowed_mime_types%'

    # Source: https://symfony.com/doc/current/service_container.html#service-parameters and https://symfony.com/doc/current/service_container.html#choose-a-specific-service
    # HOW TO ADD ANOTHER FILE HANDLER STRATEGY:
        # 1. Create a new class in the App\Service\FileHandler folder
        # 2. Implement the FileHandlerInterface
        # 3. Add the new class to the services.yaml right below this comment block
        # 4. Add the new class to the FileHandlerCollection arguments array (so it can be autowired)
        # 5. Consider adding the new upload directory to the parameters section in services.yaml file
        # 5. Now the new strategy will be automatically considered when the FileHandlerCollection is used
    App\Service\FileHandler\ImageFileStrategy:
        arguments:
            $allowedMimeTypes: '%app.allowed_image_mime_types%'
            $uploadDirectory: '%app.image_upload_directory%'

    App\Service\FileHandler\PdfFileStrategy:
        arguments:
            $allowedMimeTypes: '%app.allowed_pdf_mime_types%'
            $uploadDirectory: '%app.pdf_upload_directory%'

    App\Service\FileHandler\NoteFileStrategy:
        arguments:
            $allowedMimeTypes: '%app.allowed_note_mime_types%'

    # ZipArchiveStrategy is a special case - it is not included in the FileHandlerCollection because of the dependency loop
    App\Service\FileHandler\ZipArchiveStrategy:
        arguments:
            $allowedMimeTypes: '%app.allowed_zip_mime_types%'
            $uploadDirectory: '%app.temp_upload_directory%'

    App\Service\FileHandler\FileHandlerCollection:
        arguments:
            $fileHandlers:
                - '@App\Service\FileHandler\ImageFileStrategy'
                - '@App\Service\FileHandler\PdfFileStrategy'
                - '@App\Service\FileHandler\NoteFileStrategy'

    App\Service\FileHandler\FileAndArchiveHandlerCollection:
        arguments:
            $fileHandlers:
                - '@App\Service\FileHandler\ImageFileStrategy'
                - '@App\Service\FileHandler\PdfFileStrategy'
                - '@App\Service\FileHandler\NoteFileStrategy'
                - '@App\Service\FileHandler\ZipArchiveStrategy'